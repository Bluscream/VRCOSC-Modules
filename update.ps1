#!/usr/bin/env pwsh
# Build, commit, release, and restore debug build for VRCOSC Modules
param(
    [string]$CommitMessage = "Update VRCOSC modules",
    [switch]$SkipCommit,
    [switch]$SkipRelease,
    [switch]$NoPush
)

$ErrorActionPreference = "Stop"

# Configuration
$repoUrl = "https://github.com/Bluscream/VRCOSC-Modules"
$ProjectDir = "$PSScriptRoot\VRCOSC.Modules"
$ProjectFile = "$ProjectDir\Bluscream.Modules.csproj"
$AssemblyInfoPath = "$ProjectDir\AssemblyInfo.cs"
$SourceDll = "$ProjectDir\bin\Release\net8.0-windows10.0.26100.0\Bluscream.Modules.dll"
$ReleaseDll = "$PSScriptRoot\VRCOSC.Modules.dll"

# Functions
function New-GitHubRelease {
    param(
        [string]$Tag,
        [string]$Title,
        [string]$Notes,
        [string]$AssetPath,
        [switch]$Prerelease
    )
    
    $args = @($Tag, '--title', $Title, '--notes', $Notes, "$AssetPath#VRCOSC.Modules.dll")
    if ($Prerelease) {
        $args += '--prerelease'
    }
    
    gh release create @args
    
    return $LASTEXITCODE -eq 0
}

function Open-ManualReleasePage {
    param([string]$Tag)
    
    Write-Host "  Opening GitHub pre-release page and DLL location..." -ForegroundColor Cyan
    Start-Process "$repoUrl/releases/new?prerelease=1&tag=$Tag&title=VRCOSC+Modules+v$Tag"
    Start-Process "explorer.exe" -ArgumentList "/select,`"$ReleaseDll`""
}

Write-Host "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
Write-Host "‚ïë        VRCOSC Modules - Build & Release Script            ‚ïë" -ForegroundColor Cyan
Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Cyan
Write-Host ""

# Bump version in AssemblyInfo.cs
Write-Host "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray
Write-Host "üî¢ Bumping version..." -ForegroundColor Green
Write-Host "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray

$assemblyContent = Get-Content $AssemblyInfoPath -Raw
$versionPattern = '\[assembly: AssemblyVersion\("(\d+)\.(\d+)\.(\d+)"\)\]'

if ($assemblyContent -match $versionPattern) {
    $year = $Matches[1]
    $monthDay = $Matches[2]
    $build = [int]$Matches[3]
    
    # Get current date
    $currentDate = Get-Date
    $newYear = $currentDate.ToString("yyyy")
    $newMonthDay = $currentDate.ToString("MMdd")
    
    # If date changed, reset build number, otherwise increment
    if ($year -ne $newYear -or $monthDay -ne $newMonthDay) {
        $newBuild = 1
    }
    else {
        $newBuild = $build + 1
    }
    
    $oldVersion = "$year.$monthDay.$build"
    $newVersion = "$newYear.$newMonthDay.$newBuild"
    
    Write-Host "  Old version: $oldVersion" -ForegroundColor Yellow
    Write-Host "  New version: $newVersion" -ForegroundColor Green
    
    # Update both AssemblyVersion and AssemblyFileVersion
    $assemblyContent = $assemblyContent -replace '\[assembly: AssemblyVersion\("[\d\.]+"\)\]', "[assembly: AssemblyVersion(`"$newVersion`")]"
    $assemblyContent = $assemblyContent -replace '\[assembly: AssemblyFileVersion\("[\d\.]+"\)\]', "[assembly: AssemblyFileVersion(`"$newVersion`")]"
    
    Set-Content $AssemblyInfoPath -Value $assemblyContent -NoNewline
    Write-Host "‚úì Version bumped to $newVersion" -ForegroundColor Green
    
    $ReleaseTag = $newVersion
}
else {
    Write-Host "‚ö†Ô∏è  Could not parse version from AssemblyInfo.cs" -ForegroundColor Yellow
    $ReleaseTag = (Get-Date -Format "yyyy.MMdd.HHmm")
}

Write-Host ""

# Check if gh CLI is available for releases
$hasGhCli = $null -ne (Get-Command gh -ErrorAction SilentlyContinue)
if (-not $hasGhCli -and -not $SkipRelease) {
    Write-Host "‚ö†Ô∏è  GitHub CLI (gh) not found - releases will be skipped" -ForegroundColor Yellow
    Write-Host "   Install from: https://cli.github.com/" -ForegroundColor Yellow
    $SkipRelease = $true
}

# Step 1: Build in Release mode
Write-Host "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray
Write-Host "üì¶ Step 1: Building v$ReleaseTag in Release mode..." -ForegroundColor Green
Write-Host "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray

Push-Location $ProjectDir
try {
    dotnet build $ProjectFile -c Release | Out-Host
    if ($LASTEXITCODE -ne 0) {
        throw "Release build failed with exit code $LASTEXITCODE"
    }
    Write-Host "‚úì Release build succeeded" -ForegroundColor Green
}
finally {
    Pop-Location
}

# Step 2: Copy and rename DLL for release
Write-Host ""
Write-Host "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray
Write-Host "üìã Step 2: Copying DLL for release..." -ForegroundColor Green
Write-Host "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray

if (Test-Path $SourceDll) {
    Copy-Item $SourceDll $ReleaseDll -Force
    Write-Host "‚úì Copied: $SourceDll" -ForegroundColor Green
    Write-Host "     ‚Üí $ReleaseDll" -ForegroundColor Green
}
else {
    throw "Release DLL not found: $SourceDll"
}

# Step 3: Git commit and push
if (-not $SkipCommit) {
    Write-Host ""
    Write-Host "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray
    Write-Host "üìù Step 3: Committing changes..." -ForegroundColor Green
    Write-Host "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray
    
    Push-Location $PSScriptRoot
    try {
        # Check for changes
        $status = git status --porcelain
        if ($status) {
            git add .
            git commit -m $CommitMessage
            Write-Host "‚úì Committed: $CommitMessage" -ForegroundColor Green
            
            if (-not $NoPush) {
                $currentBranch = git rev-parse --abbrev-ref HEAD
                git push origin $currentBranch
                Write-Host "‚úì Pushed to origin/$currentBranch" -ForegroundColor Green
            }
        }
        else {
            Write-Host "‚ö†Ô∏è  No changes to commit" -ForegroundColor Yellow
        }
    }
    finally {
        Pop-Location
    }
}
else {
    Write-Host ""
    Write-Host "‚è≠Ô∏è  Skipping commit (--SkipCommit)" -ForegroundColor Yellow
}

# Step 4: Create GitHub release
if (-not $SkipRelease -and $hasGhCli) {
    Write-Host ""
    Write-Host "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray
    Write-Host "üöÄ Step 4: Creating GitHub release..." -ForegroundColor Green
    Write-Host "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray
    
    Push-Location $PSScriptRoot
    try {
        $tag = $ReleaseTag
        $title = "VRCOSC Modules v$tag (Beta)"
        $notes = "‚ö†Ô∏è **Beta Release** - Automated pre-release of Bluscream's VRCOSC modules`n`nVersion: $tag`n`nChanges:`n- $CommitMessage"
        
        # Create release
        Write-Host "Creating pre-release: $tag" -ForegroundColor Cyan
        $releaseOutput = gh release create $tag --title $title --notes $notes --prerelease "$ReleaseDll#VRCOSC.Modules.dll" 2>&1
        
        if ($LASTEXITCODE -eq 0) {
            Write-Host "‚úì Pre-release created: $tag (Beta)" -ForegroundColor Green
            Write-Host "   Attached: VRCOSC.Modules.dll" -ForegroundColor Green
        }
        else {
            Write-Host "‚ö†Ô∏è  Release creation failed (exit code: $LASTEXITCODE)" -ForegroundColor Yellow
            
            # Check if it's a workflow scope issue
            if ($releaseOutput -match "workflow.*scope") {
                Write-Host ""
                Write-Host "  GitHub CLI needs additional permissions." -ForegroundColor Yellow
                Open-ManualReleasePage -Tag $tag
                if ($false) {
                    Write-Host "  Attempting to refresh auth with workflow scope..." -ForegroundColor Cyan
                    gh auth refresh -h github.com -s workflow
                    
                    if ($LASTEXITCODE -eq 0) {
                        Write-Host ""
                        Write-Host "  ‚úì Auth refreshed. Retrying release creation..." -ForegroundColor Green
                        
                        if (New-GitHubRelease -Tag $tag -Title $title -Notes $notes -AssetPath $ReleaseDll -Prerelease) {
                            Write-Host "  ‚úì Pre-release created successfully after auth refresh!" -ForegroundColor Green
                        }
                        else {
                            Write-Host "  ‚ö†Ô∏è  Release creation still failed" -ForegroundColor Yellow
                            Open-ManualReleasePage -Tag $tag
                        }
                    }
                    else {
                        Write-Host "  ‚ö†Ô∏è  Auth refresh failed" -ForegroundColor Yellow
                        Open-ManualReleasePage -Tag $tag
                    }
                }
            }
            else {
                # Some other error - open browser
                Open-ManualReleasePage -Tag $tag
            }
        }
    }
    catch {
        Write-Host "‚ö†Ô∏è  Release creation failed: $_" -ForegroundColor Yellow
        Open-ManualReleasePage -Tag $ReleaseTag
    }
    finally {
        Pop-Location
    }
}
else {
    Write-Host ""
    Write-Host "‚è≠Ô∏è  Skipping release" -ForegroundColor Yellow
}

# Step 5: Build in Debug mode
Write-Host ""
Write-Host "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray
Write-Host "üîß Step 5: Building in Debug mode..." -ForegroundColor Green
Write-Host "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray

Push-Location $ProjectDir
try {
    dotnet build $ProjectFile -c Debug | Out-Host
    if ($LASTEXITCODE -ne 0) {
        throw "Debug build failed with exit code $LASTEXITCODE"
    }
    Write-Host "‚úì Debug build succeeded" -ForegroundColor Green
    Write-Host "   Local VRCOSC copy is now Debug build" -ForegroundColor Cyan
}
finally {
    Pop-Location
}

# Summary
Write-Host ""
Write-Host "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Green
Write-Host "‚ïë                    ‚úì ALL DONE!                             ‚ïë" -ForegroundColor Green
Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Green
Write-Host ""
Write-Host "üì¶ Release: $repoUrl/releases/tag/$ReleaseTag" -ForegroundColor Magenta
Write-Host "üìç Release DLL: $ReleaseDll" -ForegroundColor Cyan
Write-Host "üìç Local VRCOSC: %APPDATA%\VRCOSC\packages\local\Bluscream.Modules.dll (Debug)" -ForegroundColor Cyan
Write-Host ""
